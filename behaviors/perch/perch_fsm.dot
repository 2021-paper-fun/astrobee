# dot -Tpdf statemachine.dot -o statemachine.pdf
digraph G {
  graph [label="PERCH\n", labelloc=t, fontsize=50];
  ratio="fill";
  size="8.3,11.7!";
  node [shape=box, width=4, fontsize=12, fontname="helvetica"];
  edge [arrowsize=2, weight=2., fontsize=12, fontname="helvetica"];
  fontname = "helvetica";

  node [shape=diamond, style=filled, fillcolor=lightblue, color=black];
  INITIALIZING;

  node [shape=box, style=filled, fillcolor=lightblue, color=black];
  UNKNOWN;
  UNPERCHED;
  PERCHED;

  node [shape=box, style=filled, fillcolor=aquamarine, color=black]; 
  PERCHING_RECOVERY_CLOSING_GRIPPER;
  PERCHING_RECOVERY_STOWING_ARM;
  PERCHING_RECOVERY_OPENING_GRIPPER;
  PERCHING_RECOVERY_MOVING_TO_APPROACH_POSE;
  PERCHING_RECOVERY_SWITCH_TO_ML_LOC;

  node [shape=box, style=filled, fillcolor=gold, color=black];
  PERCHING_SWITCHING_TO_HR_LOC;
  PERCHING_MOVING_TO_APPROACH_POSE;
  PERCHING_DEPLOYING_ARM;
  PERCHING_CALIBRATING_GRIPPER;
  PERCHING_OPENING_GRIPPER;
  PERCHING_MOVING_TO_COMPLETE_POSE;
  PERCHING_CLOSING_GRIPPER;
  PERCHING_CHECKING_ATTACHED;
  PERCHING_WAITING_FOR_SPIN_DOWN;
  PERCHING_SWITCHING_TO_PL_LOC;

  node [shape=box, style=filled, fillcolor=lightpink, color=black];
  UNPERCHING_SWITCHING_TO_ML_LOC;
  UNPERCHING_WAITING_FOR_SPIN_UP;
  UNPERCHING_CALIBRATING_GRIPPER;
  UNPERCHING_OPENING_GRIPPER;
  UNPERCHING_MOVING_TO_APPROACH_POSE;
  UNPERCHING_CLOSING_GRIPPER;
  UNPERCHING_STOWING_ARM;

  # Transparent state changes
  INITIALIZING -> UNKNOWN
    [label="[0]\nE:READY", color=blue];
  UNKNOWN -> UNPERCHED
    [label="[1]\nE:ARM_STOWED", color=blue];

  # Nominal perch
  UNPERCHED -> PERCHING_SWITCHING_TO_HR_LOC
    [label="[5]\nE:GOAL_PERCH\nSwitch(HR)"];
  PERCHING_SWITCHING_TO_HR_LOC -> PERCHING_MOVING_TO_APPROACH_POSE
    [label="[6]\nE:SWITCH_SUCCESS\nTeleop(APPROACH)"];
  PERCHING_MOVING_TO_APPROACH_POSE -> PERCHING_DEPLOYING_ARM
    [label="[7]\nE:TELEOP_SUCCESS\nArm(DEPLOY)"];
  PERCHING_DEPLOYING_ARM -> PERCHING_CALIBRATING_GRIPPER
    [label="[8]\nE:ARM_SUCCESS\nArm(CALIBRATE)", style=dashed];
  PERCHING_DEPLOYING_ARM -> PERCHING_OPENING_GRIPPER
    [label="[8]\nE:ARM_SUCCESS\nArm(CALIBRATE)"];
  PERCHING_CALIBRATING_GRIPPER -> PERCHING_OPENING_GRIPPER
    [label="[9]\nE:ARM_SUCCESS\nArm(OPEN)", style=dashed];
  PERCHING_OPENING_GRIPPER -> PERCHING_MOVING_TO_COMPLETE_POSE
    [label="[10]\nE:ARM_SUCCESS\nTeleop(COMPLETE)"];
  PERCHING_MOVING_TO_COMPLETE_POSE -> PERCHING_CLOSING_GRIPPER
    [label="[11]\nE:TELEOP_SUCCESS\nArm(CLOSE)"];
  PERCHING_CLOSING_GRIPPER -> PERCHING_CHECKING_ATTACHED
    [label="[12]\nE:ARM_SUCCESS\nTeleop(ATTACHED)"];
  PERCHING_CHECKING_ATTACHED -> PERCHING_WAITING_FOR_SPIN_DOWN 
    [label="[13]\nE:TELEOP_FAILED\nBlowers(OFF)"];
  PERCHING_WAITING_FOR_SPIN_DOWN -> PERCHING_SWITCHING_TO_PL_LOC
    [label="[14]\nE:PMC_OFF\nSwitch(PL)" ];
  PERCHING_SWITCHING_TO_PL_LOC -> PERCHED
    [label="[15]\nE:SWITCH_SUCCESS", color=darkgreen];

  # Off-nominal perch
  PERCHING_SWITCHING_TO_HR_LOC -> UNPERCHED
    [label="[5]\nE:SWITCH_FAILED", color=red];
  PERCHING_MOVING_TO_APPROACH_POSE -> PERCHING_RECOVERY_SWITCH_TO_ML_LOC
    [color=red];
  PERCHING_CALIBRATING_GRIPPER -> PERCHING_RECOVERY_STOWING_ARM
    [color=red];
  PERCHING_DEPLOYING_ARM -> PERCHING_RECOVERY_STOWING_ARM
    [color=red];
  PERCHING_OPENING_GRIPPER -> PERCHING_RECOVERY_CLOSING_GRIPPER
    [color=red];
  PERCHING_MOVING_TO_COMPLETE_POSE -> PERCHING_RECOVERY_MOVING_TO_APPROACH_POSE
    [color=red];
  PERCHING_CLOSING_GRIPPER -> PERCHING_RECOVERY_OPENING_GRIPPER
    [color=red];
  PERCHING_CHECKING_ATTACHED -> PERCHING_RECOVERY_OPENING_GRIPPER
    [color=red];
  PERCHING_WAITING_FOR_SPIN_DOWN -> PERCHED
    [color=red];
  PERCHING_SWITCHING_TO_PL_LOC -> PERCHED
    [color=red];
  PERCHING_RECOVERY_OPENING_GRIPPER -> PERCHING_RECOVERY_MOVING_TO_APPROACH_POSE
    [color=blue];
  PERCHING_RECOVERY_MOVING_TO_APPROACH_POSE -> PERCHING_RECOVERY_CLOSING_GRIPPER
    [color=blue];
  PERCHING_RECOVERY_CLOSING_GRIPPER -> PERCHING_RECOVERY_STOWING_ARM
    [color=blue];
  PERCHING_RECOVERY_STOWING_ARM -> PERCHING_RECOVERY_SWITCH_TO_ML_LOC
    [color=blue];
  PERCHING_RECOVERY_SWITCH_TO_ML_LOC -> UNPERCHED
    [color=blue];

  # Nominal unperch
  PERCHED -> UNPERCHING_SWITCHING_TO_ML_LOC
    [label="[16]\nE:GOAL_UNPERCH\nSwitch(ML)"];
  UNPERCHING_SWITCHING_TO_ML_LOC -> UNPERCHING_WAITING_FOR_SPIN_UP
    [label="[17]\nE:SWITCH_SUCCESS\nBlowers(ON)"];
  UNPERCHING_WAITING_FOR_SPIN_UP -> UNPERCHING_CALIBRATING_GRIPPER
    [label="[18]\nE:PMC_READY\nArm(OPEN)", style=dashed];
  UNPERCHING_CALIBRATING_GRIPPER -> UNPERCHING_OPENING_GRIPPER
    [label="[18]\nE:PMC_READY\nArm(OPEN)", style=dashed];
  UNPERCHING_WAITING_FOR_SPIN_UP -> UNPERCHING_OPENING_GRIPPER
    [label="[18]\nE:PMC_READY\nArm(OPEN)"];
  UNPERCHING_OPENING_GRIPPER -> UNPERCHING_MOVING_TO_APPROACH_POSE
    [label="[19]\nE:ARM_SUCCESS\nTeleop(APPROACH)"];
  UNPERCHING_MOVING_TO_APPROACH_POSE -> UNPERCHING_CLOSING_GRIPPER
    [label="[20]\nE:TELEOP_SUCCESS\nArm(CLOSE)"];
  UNPERCHING_CLOSING_GRIPPER -> UNPERCHING_STOWING_ARM
    [label="[21]\nE:ARM_SUCCESS\nArm(STOW)"];
  UNPERCHING_STOWING_ARM -> UNPERCHED
    [label="[22]\nE:ARM_SUCCESS", color=darkgreen];

  # Off-nominal unperch
  UNPERCHING_SWITCHING_TO_ML_LOC -> PERCHED
    [color=red];
  UNPERCHING_WAITING_FOR_SPIN_UP -> PERCHED
    [color=red];
  UNPERCHING_CALIBRATING_GRIPPER -> PERCHED
    [color=red];
  UNPERCHING_OPENING_GRIPPER -> PERCHED
    [color=red];

}